---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
  // This would be populated at build time
  return [];
}

const { slug } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

let post = null;
let relatedPosts = [];

try {
  // Fetch post by slug
  const postResponse = await fetch(`${API_URL}/api/posts?where[slug][equals]=${slug}&limit=1`);
  if (postResponse.ok) {
    const data = await postResponse.json();
    post = data.docs?.[0] || null;
  }
  
  // Fetch related posts
  if (post) {
    const relatedResponse = await fetch(
      `${API_URL}/api/posts?where[status][equals]=published&where[id][not_equals]=${post.id}&limit=3&sort=-publishedAt`
    );
    if (relatedResponse.ok) {
      const data = await relatedResponse.json();
      relatedPosts = data.docs || [];
    }
  }
} catch (error) {
  console.error('Error fetching post:', error);
}

if (!post) {
  return Astro.redirect('/404');
}
---

<Layout title={post.title} description={post.excerpt} image={post.featuredImage?.url}>
  <div class="min-h-screen bg-gray-50">
    <Header />
    
    <main class="py-12">
      <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        {post.featuredImage && (
          <div class="mb-8">
            <img
              src={post.featuredImage.url}
              alt={post.title}
              class="w-full h-64 md:h-96 object-cover rounded-lg"
            />
          </div>
        )}
        
        <header class="mb-8">
          <div class="flex items-center text-sm text-gray-500 mb-4">
            <time datetime={post.publishedAt}>
              {new Date(post.publishedAt).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
            {post.author && (
              <>
                <span class="mx-2">•</span>
                <span>{post.author.name}</span>
              </>
            )}
            {post.categories && post.categories.length > 0 && (
              <>
                <span class="mx-2">•</span>
                <span>{post.categories[0].name}</span>
              </>
            )}
          </div>
          
          <h1 class="text-4xl font-bold text-gray-900 mb-4">
            {post.title}
          </h1>
          
          {post.excerpt && (
            <p class="text-xl text-gray-600 mb-6">
              {post.excerpt}
            </p>
          )}
          
          {post.tags && post.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {post.tags.map((tag) => (
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                  {tag.name}
                </span>
              ))}
            </div>
          )}
        </header>
        
        <div class="prose prose-lg max-w-none">
          <div set:html={post.content} />
        </div>
        
        {relatedPosts.length > 0 && (
          <section class="mt-16 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Artikel Terkait</h2>
            <div class="grid gap-6 md:grid-cols-3">
              {relatedPosts.map((relatedPost) => (
                <article class="bg-white rounded-lg shadow-md overflow-hidden">
                  {relatedPost.featuredImage && (
                    <img
                      src={relatedPost.featuredImage.url}
                      alt={relatedPost.title}
                      class="w-full h-32 object-cover"
                    />
                  )}
                  <div class="p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">
                      <a href={`/posts/${relatedPost.slug}`} class="hover:text-blue-600">
                        {relatedPost.title}
                      </a>
                    </h3>
                    {relatedPost.excerpt && (
                      <p class="text-sm text-gray-600 line-clamp-2">
                        {relatedPost.excerpt}
                      </p>
                    )}
                  </div>
                </article>
              ))}
            </div>
          </section>
        )}
      </article>
    </main>
    
    <Footer />
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .prose {
    color: #374151;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    color: #111827;
    font-weight: 600;
  }
  
  .prose p {
    margin-bottom: 1.25em;
  }
  
  .prose ul, .prose ol {
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }
  
  .prose li {
    margin-bottom: 0.5em;
  }
  
  .prose blockquote {
    border-left: 4px solid #e5e7eb;
    padding-left: 1em;
    margin-left: 0;
    font-style: italic;
    color: #6b7280;
  }
  
  .prose code {
    background-color: #f3f4f6;
    padding: 0.125em 0.25em;
    border-radius: 0.25em;
    font-size: 0.875em;
  }
  
  .prose pre {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1em;
    border-radius: 0.5em;
    overflow-x: auto;
  }
  
  .prose img {
    border-radius: 0.5em;
  }
</style>